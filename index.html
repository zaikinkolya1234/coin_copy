<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BTC график — 5с свечи (панорама и масштаб)</title>
  <style>
    html, body {
      height: 100%;
      margin: 0;
      font-family: -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, 'Helvetica Neue', Arial, 'Noto Sans', 'Liberation Sans', sans-serif;
      background: #0e1116;
      color: #e6e6e6;
    }
    .wrap {
      height: 100%;
      display: grid;
      grid-template-rows: auto 1fr auto;
      gap: 8px;
      padding: 12px;
      box-sizing: border-box;
    }
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }
    .panel {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }
    .chart {
      position: relative;
      height: 100%;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 2px 20px rgba(0,0,0,.35);
      background: #0b0e13;
    }
    .chart #tv {
      position: absolute;
      inset: 0;
    }
    .overlay {
      position: absolute;
      top: 8px; left: 8px;
      background: rgba(0,0,0,.45);
      padding: 8px 10px;
      border-radius: 8px;
      font-size: 12px;
      line-height: 1.35;
      pointer-events: none;
      white-space: pre-line;
    }
    .footer {
      opacity: .75;
      font-size: 12px;
    }
    .badge {
      padding: 2px 6px;
      border-radius: 6px;
      background: #1b2130;
      border: 1px solid #2a3347;
      font-size: 12px;
    }
    select, button, input[type="checkbox"] {
      background: #151a22;
      color: #e6e6e6;
      border: 1px solid #2a3347;
      padding: 6px 8px;
      border-radius: 8px;
    }
    button { cursor: pointer; }
  </style>
  <!-- Lightweight Charts CDN -->
  <script src="https://unpkg.com/lightweight-charts@4.1.1/dist/lightweight-charts.standalone.production.js"></script>
</head>
<body>
<div class="wrap">
  <div class="header">
    <div class="panel">
      <strong>BTC/USDT • 5‑сек свечи</strong>
      <span class="badge" id="status">Подключение…</span>
      <label class="badge" style="display:flex;gap:6px;align-items:center">
        <input id="autoscale" type="checkbox" checked>
        Автомасштаб
      </label>
      <button id="reset">Сбросить масштаб</button>
    </div>
  </div>

  <div class="chart">
    <div id="tv"></div>
    <div class="overlay">
      Управление:\n
      • Колесо мыши — масштаб по времени\n
      • Зажать шкалу цен и тянуть — вертикальный масштаб\n
      • Зажать график и тянуть — прокрутка\n
      • Двойной клик по шкале — авто-масштаб\n    </div>
  </div>

  <div class="footer">Данные: прямой поток сделок Binance (btcusdt@trade). Свечи собираются клиентом по 5 секунд. Только в информационных целях.</div>
</div>

<script>
(function () {
  const FIVE_SEC = 5; // длительность свечи в секундах
  const symbol = 'btcusdt';
  const wsEndpoint = `wss://stream.binance.com:9443/ws/${symbol}@trade`;

  // Инициализация графика
  const container = document.getElementById('tv');
  const chart = LightweightCharts.createChart(container, {
    layout: { background: { type: 'solid', color: '#0b0e13' }, textColor: '#d1d4dc' },
    rightPriceScale: { borderColor: '#2a3347', scaleMargins: { top: 0.1, bottom: 0.1 } },
    timeScale: {
      borderColor: '#2a3347',
      timeVisible: true,
      secondsVisible: true,
      rightOffset: 8,
      fixLeftEdge: false,
      fixRightEdge: false,
    },
    grid: { vertLines: { color: '#1b2434' }, horzLines: { color: '#1b2434' } },
    crosshair: { mode: LightweightCharts.CrosshairMode.Normal },
    handleScroll: { mouseWheel: true, pressedMouseMove: true },
    handleScale: {
      axisPressedMouseMove: { time: true, price: true },
      mouseWheel: true,
      pinch: true,
    },
  });

  const series = chart.addCandlestickSeries({
    upColor: '#26a69a', downColor: '#ef5350', borderDownColor: '#ef5350', borderUpColor: '#26a69a', wickDownColor: '#ef5350', wickUpColor: '#26a69a'
  });

  // Адаптация к размеру контейнера
  const resize = () => chart.applyOptions({ width: container.clientWidth, height: container.clientHeight });
  new ResizeObserver(resize).observe(container.parentElement);
  window.addEventListener('load', resize);

  // Автомасштаб по последним барам
  const autoscaleCheckbox = document.getElementById('autoscale');
  autoscaleCheckbox.addEventListener('change', () => {
    if (autoscaleCheckbox.checked) series.priceScale().applyOptions({ autoScale: true });
  });
  document.getElementById('reset').addEventListener('click', () => {
    chart.timeScale().fitContent();
    series.priceScale().applyOptions({ autoScale: true });
  });

  // Агрегатор 5‑секундных свечей
  let lastCandle = null; // текущая строящаяся свеча
  const candles = []; // массив закрытых свечей

  function floorToStep(tsSec, stepSec) {
    return Math.floor(tsSec / stepSec) * stepSec;
  }

  function pushTrade(price, size, tsMs) {
    const tsSec = Math.floor(tsMs / 1000);
    const bucket = floorToStep(tsSec, FIVE_SEC);

    if (!lastCandle || lastCandle.time !== bucket) {
      // Закрыть предыдущую свечу, если она была
      if (lastCandle) {
        candles.push(lastCandle);
        series.update(lastCandle); // зафиксировать пред. свечу
      }
      // Начать новую
      lastCandle = {
        time: bucket,
        open: price,
        high: price,
        low: price,
        close: price,
        volume: size || 0,
      };
      series.update(lastCandle);
      if (autoscaleCheckbox.checked) series.priceScale().applyOptions({ autoScale: true });
      return;
    }

    // Обновление текущей свечи
    if (price > lastCandle.high) lastCandle.high = price;
    if (price < lastCandle.low) lastCandle.low = price;
    lastCandle.close = price;
    lastCandle.volume += size || 0;
    series.update(lastCandle);
  }

  // Статус
  const status = document.getElementById('status');
  function setStatus(s) { status.textContent = s; }

  // WebSocket c автопереподключением
  let ws;
  let reconnectTimer = null;

  function connect() {
    try {
      ws = new WebSocket(wsEndpoint);
    } catch (e) {
      setStatus('Ошибка инициации WS');
      scheduleReconnect();
      return;
    }

    ws.onopen = () => setStatus('Онлайн');

    ws.onmessage = (ev) => {
      try {
        const msg = JSON.parse(ev.data);
        // Binance trade: { p: price, q: qty, T: tradeTime }
        const price = parseFloat(msg.p);
        const qty = parseFloat(msg.q);
        const t = msg.T; // ms
        if (Number.isFinite(price) && Number.isFinite(qty) && Number.isFinite(t)) {
          pushTrade(price, qty, t);
        }
      } catch (e) {
        // игнорировать некорректные сообщения
      }
    };

    ws.onclose = () => { setStatus('Офлайн — переподключение'); scheduleReconnect(); };
    ws.onerror = () => { setStatus('Ошибка — переподключение'); try { ws.close(); } catch(_){} };
  }

  function scheduleReconnect() {
    if (reconnectTimer) return;
    reconnectTimer = setTimeout(() => {
      reconnectTimer = null;
      connect();
    }, 1500);
  }

  connect();
})();
</script>
</body>
</html>
