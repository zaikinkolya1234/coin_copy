<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BTC — свечи 5s (Demo)</title>

  <!-- Lightweight Charts -->
  <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>

  <style>
    :root{
      --bg:#0b0b0c; --panel:#0f1115; --ink:#e6e8ee; --line:#1a1d23;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial}
    .wrap{display:flex;flex-direction:column;height:100%}
    header{display:flex;align-items:center;gap:10px;padding:10px 12px;border-bottom:1px solid var(--line);background:#0e1015}
    #status{font-size:12px;opacity:.8}
    main{flex:1;display:flex;flex-direction:column;gap:8px;padding:10px}
    #chart{height:70vh;min-height:360px;border:1px solid var(--line);border-radius:12px}
    .toolbar{display:flex;gap:8px;align-items:center;justify-content:space-between}
    button{background:#1a2a55;border:1px solid #22376f;color:#fff;padding:8px 12px;border-radius:8px;cursor:pointer}
    button:disabled{opacity:.6;cursor:not-allowed}
    .muted{opacity:.7;font-size:12px}
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <div><strong>BTC/USDT</strong> — свечи 5&nbsp;секунд</div>
    <div id="lastPrice">—</div>
    <div id="status" class="muted">Отключено</div>
  </header>

  <main>
    <div id="chart"></div>
    <div class="toolbar">
      <div class="muted">Колесо мыши — масштаб, зажатая левая кнопка — прокрутка. Двойной клик — авто-масштаб.</div>
      <div>
        <button id="fit">Сброс масштаба</button>
      </div>
    </div>
  </main>
</div>

<script>
(() => {
  // --- График ---
  const chart = LightweightCharts.createChart(document.getElementById('chart'), {
    layout: { background: { type: 'solid', color: '#0f1115' }, textColor: '#cbd3df' },
    grid: { vertLines: { color: '#151a24' }, horzLines: { color: '#151a24' } },
    rightPriceScale: { borderColor: '#1a1d23' },
    timeScale: {
      borderColor: '#1a1d23',
      timeVisible: true,
      secondsVisible: true,
      fixLeftEdge: false,
      fixRightEdge: false,
    },
    crosshair: { mode: LightweightCharts.CrosshairMode.Normal },
  });
  const series = chart.addCandlestickSeries({
    upColor: '#26a69a', downColor: '#ef5350',
    wickUpColor: '#26a69a', wickDownColor: '#ef5350',
    borderUpColor: '#26a69a', borderDownColor: '#ef5350',
  });

  document.getElementById('fit').addEventListener('click', () => chart.timeScale().fitContent());
  chart.subscribeDblClick(() => chart.timeScale().fitContent());

  // --- Агрегация в свечи 5s ---
  const TF_MS = 5000;               // таймфрейм 5 секунд
  const MAX_CANDLES = 1200;         // ~100 минут истории
  let candles = [];                 // массив завершённых свечей
  let cur = null;                   // текущая (незавершённая) свеча
  let lastBucket = 0;

  function pushFinal(c) {
    candles.push(c);
    if (candles.length > MAX_CANDLES) candles.shift();
  }

  function handleTrade(price, tsMs) {
    const bucketStart = Math.floor(tsMs / TF_MS) * TF_MS;
    if (!cur || bucketStart !== lastBucket) {
      if (cur) pushFinal(cur);
      cur = { time: Math.floor(bucketStart / 1000), open: price, high: price, low: price, close: price };
      lastBucket = bucketStart;
      // полная перерисовка с "хвостом" из текущей свечи
      series.setData([...candles, cur]);
    } else {
      cur.high = Math.max(cur.high, price);
      cur.low  = Math.min(cur.low,  price);
      cur.close = price;
      series.update(cur);
    }
  }

  // --- WebSocket Binance (spot) ---
  const statusEl = document.getElementById('status');
  const lastPriceEl = document.getElementById('lastPrice');
  let ws = null;
  let reconnectTimer = null;

  function setStatus(text) { statusEl.textContent = text; }
  function connect() {
    clearTimeout(reconnectTimer);
    if (ws) try { ws.close(); } catch {}
    ws = new WebSocket('wss://stream.binance.com:9443/ws/btcusdt@trade');
    ws.onopen = () => setStatus('Подключено');
    ws.onclose = () => { setStatus('Переподключение…'); reconnectTimer = setTimeout(connect, 1500); };
    ws.onerror = () => ws.close();
    ws.onmessage = (ev) => {
      // Документация: поле p — цена, T — время сделки (мс)
      // https://binance-docs.github.io/apidocs/spot/en/#aggregate-trade-streams
      try {
        const j = JSON.parse(ev.data);
        const p = parseFloat(j.p ?? j.price ?? j.data?.p);
        const t = Number(j.T ?? j.data?.T ?? Date.now());
        if (!Number.isFinite(p)) return;
        lastPriceEl.textContent = `Последняя цена: ${p.toFixed(2)} USDT`;
        handleTrade(p, t);
      } catch {}
    };
  }
  connect();

  // --- Страховочный тикер: если трафика мало, форс-обновляем текущую свечу раз в 1с ---
  setInterval(() => { if (cur) series.update(cur); }, 1000);

  // --- Начальная подгонка масштаба ---
  const fitOnce = setInterval(() => {
    if (candles.length + (cur ? 1 : 0) > 30) {
      chart.timeScale().fitContent();
      clearInterval(fitOnce);
    }
  }, 500);
})();
</script>
</body>
</html>
